from . import settings
from typing import List, Queue
from queue import Queue
from threading import Thread, Lock
from time import sleep

# <TEMP>
# https://www.silabs.com/documents/public/application-notes/AN633.pdf
# https://www.silabs.com/documents/public/data-sheets/Si4468-7.pdf

# Hardware dependent libraries and initialization
if not settings.MOCK_MODE:
    import board
    from digitalio import DigitalInOut, Direction
    from spidev import SpiDev    
    
    # SPI bus for radio transceiver
    RADIO_SPI = SpiDev(
        bus = 0,
        device = 0,
    )

# Maximum permissible data rate
RADIO_MAX_DATA_RATE = 1000000

# Minimum permissible data rate
RADIO_MIN_DATA_RATE = 1000

# Minimum permissible data rate deviation as a factor of data rate
RADIO_MIN_DATA_RATE_DEVIATION_FACTOR = 0.1

# Maximum permissible channel spacing
RADIO_MAX_CHANNEL_SPACING = 500000

# Minimum permissible channel spacing
RADIO_MIN_CHANNEL_SPACING = 50000

# <TODO>
RADIO_CMD_READ_CMD_BUFFER = 0x44
RADIO_CMD_SET_PROPERTY = 0x11

# <TODO>
RADIO_VAL_CTS_READY = 0xFF

# <TODO>
RADIO_CONFIG_PROPERTIES = [
    [0x00, 2, 0x00, [0x11, 0x00, 0x02, 0x00, 0x00, 0x00]],  # RF_GLOBAL_XO_TUNE_2
    [0x00, 1, 0x03, [0x11, 0x00, 0x01, 0x03, 0x20]],  # RF_GLOBAL_CONFIG_1
    [0x01, 1, 0x00, [0x11, 0x01, 0x01, 0x00, 0x00]],  # RF_INT_CTL_ENABLE_1
    [0x02, 4, 0x00, [0x11, 0x02, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00]],  # RF_FRR_CTL_A_MODE_4
    [0x10, 9, 0x00, [0x11, 0x10, 0x09, 0x00, 0x08, 0x14, 0x00, 0x0F, 0x31, 0x00, 0x00, 0x00, 0x00]],  # RF_PREAMBLE_TX_LENGTH_9
    [0x11, 10, 0x00, [0x11, 0x11, 0x0A, 0x00, 0x01, 0xB4, 0x2B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]],  # RF_SYNC_CONFIG_10
    [0x12, 12, 0x00, [0x11, 0x12, 0x0C, 0x00, 0x04, 0x01, 0x08, 0xFF, 0xFF, 0x20, 0x02, 0x00, 0x2A, 0x01, 0x00, 0x20]],  # RF_PKT_CRC_CONFIG_12
    [0x12, 12, 0x0C, [0x11, 0x12, 0x0C, 0x0C, 0x20, 0x00, 0x01, 0x04, 0x82, 0x00, 0x07, 0x00, 0x22, 0x00, 0x00, 0x00]],  # RF_PKT_RX_THRESHOLD_12
    [0x12, 12, 0x18, [0x11, 0x12, 0x0C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]],  # RF_PKT_FIELD_3_CRC_CONFIG_12
    [0x12, 12, 0x24, [0x11, 0x12, 0x0C, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]],  # RF_PKT_RX_FIELD_1_CRC_CONFIG_12
    [0x12, 5, 0x30, [0x11, 0x12, 0x05, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00]],  # RF_PKT_RX_FIELD_4_CRC_CONFIG_5
    [0x12, 4, 0x36, [0x11, 0x12, 0x04, 0x36, 0x00, 0x00, 0x00, 0x00]],  # RF_PKT_CRC_SEED_31_24_4
    [0x20, 12, 0x00, [0x11, 0x20, 0x0C, 0x00, 0x03, 0x00, 0x07, 0x1E, 0x84, 0x80, 0x09, 0xC9, 0xC3, 0x80, 0x00, 0x06]],  # RF_MODEM_MOD_TYPE_12 --------- data rate is 3, 4, 5 (reverse order), freq dev is 11, 12 (reverse order)
    [0x20, 1, 0x0C, [0x11, 0x20, 0x01, 0x0C, 0xD4]],  # RF_MODEM_FREQ_DEV_0_1
    [0x20, 12, 0x18, [0x11, 0x20, 0x0C, 0x18, 0x01, 0x00, 0x08, 0x03, 0xC0, 0x00, 0x10, 0x20, 0x00, 0xE8, 0x00, 0x4B]],  # RF_MODEM_TX_RAMP_DELAY_12
    [0x20, 12, 0x24, [0x11, 0x20, 0x0C, 0x24, 0x06, 0xD3, 0xA0, 0x06, 0xD4, 0x02, 0x00, 0x00, 0x00, 0x23, 0x83, 0x6A]],  # RF_MODEM_BCR_NCO_OFFSET_2_12
    [0x20, 3, 0x30, [0x11, 0x20, 0x03, 0x30, 0x00, 0xD3, 0xA0]],  # RF_MODEM_AFC_LIMITER_1_3
    [0x20, 1, 0x35, [0x11, 0x20, 0x01, 0x35, 0xE0]],  # RF_MODEM_AGC_CONTROL_1
    [0x20, 12, 0x38, [0x11, 0x20, 0x0C, 0x38, 0x11, 0x10, 0x10, 0x80, 0x1A, 0x40, 0x00, 0x00, 0x28, 0x0C, 0xA4, 0x23]],  # RF_MODEM_AGC_WINDOW_SIZE_12
    [0x20, 10, 0x45, [0x11, 0x20, 0x0A, 0x45, 0x03, 0x01, 0x15, 0x01, 0x00, 0xFF, 0x06, 0x00, 0x18, 0x40]],  # RF_MODEM_RAW_CONTROL_10
    [0x20, 2, 0x50, [0x11, 0x20, 0x02, 0x50, 0x84, 0x08]],  # RF_MODEM_RAW_SEARCH2_2
    [0x20, 2, 0x54, [0x11, 0x20, 0x02, 0x54, 0x04, 0x07]],  # RF_MODEM_SPIKE_DET_2
    [0x20, 1, 0x57, [0x11, 0x20, 0x01, 0x57, 0x00]],  # RF_MODEM_RSSI_MUTE_1
    [0x20, 5, 0x5B, [0x11, 0x20, 0x05, 0x5B, 0x40, 0x04, 0x08, 0x78, 0x20]],  # RF_MODEM_DSA_CTRL1_5
    [0x21, 12, 0x00, [0x11, 0x21, 0x0C, 0x00, 0xFF, 0xC4, 0x30, 0x7F, 0xF5, 0xB5, 0xB8, 0xDE, 0x05, 0x17, 0x16, 0x0C]],  # RF_MODEM_CHFLT_RX1_CHFLT_COE13_7_0_12
    [0x21, 12, 0x0C, [0x11, 0x21, 0x0C, 0x0C, 0x03, 0x00, 0x15, 0xFF, 0x00, 0x00, 0xFF, 0xC4, 0x30, 0x7F, 0xF5, 0xB5]],  # RF_MODEM_CHFLT_RX1_CHFLT_COE1_7_0_12
    [0x21, 12, 0x18, [0x11, 0x21, 0x0C, 0x18, 0xB8, 0xDE, 0x05, 0x17, 0x16, 0x0C, 0x03, 0x00, 0x15, 0xFF, 0x00, 0x00]],  # RF_MODEM_CHFLT_RX2_CHFLT_COE7_7_0_12
    [0x22, 4, 0x00, [0x11, 0x22, 0x04, 0x00, 0x08, 0x7F, 0x00, 0x1D]],  # RF_PA_MODE_4
    [0x23, 7, 0x00, [0x11, 0x23, 0x07, 0x00, 0x34, 0x04, 0x0B, 0x04, 0x07, 0x70, 0x03]],  # RF_SYNTH_PFDCP_CPFF_7
    [0x30, 12, 0x00, [0x11, 0x30, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]],  # RF_MATCH_VALUE_1_12
    [0x40, 8, 0x00, [0x11, 0x40, 0x08, 0x00, 0x3C, 0x08, 0x00, 0x00, 0x22, 0x22, 0x20, 0xFF]],  # RF_FREQ_CONTROL_INTE_8
]

class Radio:
    
    def _update_thread(self) -> None:
        """
        Internal thread which periodically services the radio transceiver.
        """
        while not self._shutdown_flag:
            # <TODO>
            sleep(1.0 / settings.RADIO_UPDATE_RATE)
    
    def __init__(self, data_rate: int, data_rate_deviation: int, channel_spacing: int) -> None:
        """
        <TODO>
        """
        if data_rate < RADIO_MIN_DATA_RATE:
            raise ValueError(f"Radio has invalid data rate: {data_rate} < {RADIO_MIN_DATA_RATE}")
        if data_rate > RADIO_MAX_DATA_RATE:
            raise ValueError(f"Radio has invalid data rate: {data_rate} > {RADIO_MAX_DATA_RATE}")
        if data_rate_deviation < (data_rate * RADIO_MIN_DATA_RATE_DEVIATION_FACTOR):
            raise ValueError(f"Radio has invalid data rate deviation: {data_rate_deviation} < {data_rate * RADIO_MIN_DATA_RATE_DEVIATION_FACTOR}")
        if data_rate_deviation > data_rate:
            raise ValueError(f"Radio has invalid data rate deviation: {data_rate_deviation} > {data_rate}")
        if channel_spacing < RADIO_MIN_CHANNEL_SPACING:
            raise ValueError(f"Radio has invalid channel spacing: {channel_spacing} < {RADIO_MIN_CHANNEL_SPACING}")
        if channel_spacing > RADIO_MAX_CHANNEL_SPACING:
            raise ValueError(f"Radio has invalid channel spacing: {channel_spacing} > {RADIO_MAX_CHANNEL_SPACING}")
        
        self._data_rate = data_rate
        self._data_rate_deviation = data_rate_deviation
        self._channel_spacing = channel_spacing
        self._shutdown_flag = False
        self._thread_lock = Lock()
        self._tx_queue: Queue[bytearray] = Queue()
        self._rx_queue: Queue[bytearray] = Queue()
        
        def wait_cts_reg(self) -> None:
            """
            Waits for the Clear To Send (CTS) register from the radio transceiver (blocking).
            """
            cts: bool = False
            while not cts:
                rx = RADIO_SPI.xfer2([RADIO_CMD_READ_CMD_BUFFER, 0x00])
                cts = (rx[1] & 0xFF) == RADIO_VAL_CTS_READY
                                
        
        self._update_thread = Thread(target=self._update_thread)
        self._update_thread.start()
        
        
    @classmethod
    def from_config(cls, config: dict) -> "Radio":
        ...
        
    def __del__(self) -> None:
        self._shutdown()

    def transmit(self, data: List[bytearray]) -> None:
        ...
        
    def receive(self) -> List[bytearray]:
        ...
    
    def shutdown(self) -> None:
        ...